<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-light d-flex justify-content-center align-items-center vh-100">
  <div class="container bg-white p-4 shadow rounded">
    <h1 class="text-center">Task Manager</h1>

    <button id="logoutBtn" class="btn btn-danger w-100 my-3 d-none">Logout</button>

    <!-- Register/Login Toggle -->
    <ul class="nav nav-tabs mb-3" id="authTabs">
      <li class="nav-item">
        <button class="nav-link active" id="loginTab">Login</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="registerTab">Register</button>
      </li>
    </ul>

    <!-- Register Form -->
    <form id="registerForm" class="mb-3 d-none">
      <input type="text" id="registerUsername" placeholder="Username" class="form-control mb-2">
      <input type="password" id="registerPassword" placeholder="Password" class="form-control mb-2">
      <button type="submit" class="btn btn-success w-100">Register</button>
    </form>

    <!-- Login Form -->
    <form id="loginForm" class="mb-3">
      <input type="text" id="username" placeholder="Username" class="form-control mb-2">
      <input type="password" id="password" placeholder="Password" class="form-control mb-2">
      <button type="submit" class="btn btn-primary w-100">Login</button>
    </form>

    <!-- Task Input -->
    <div class="input-group mb-3">
      <input type="text" id="taskInput" placeholder="Enter task name" class="form-control">
      <button id="addTask" class="btn btn-success">Add Task</button>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="text-center text-secondary d-none">
      <div class="spinner-border" role="status"></div>
      <p>Loading tasks...</p>
    </div>

    <ul id="taskList" class="list-group"></ul>
  </div>

  <!-- Toast Container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toastContainer"></div>
  </div>

  <!-- Modal for Edit -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="editTaskTitle" class="form-control">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveEdit">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const socket = io();
      // Real-time updates
        socket.on("taskCreated", (task) => {
        addTaskToUI(task);
        });

        socket.on("taskUpdated", (task) => {
        const existing = document.querySelector(`[data-id="${task.id}"]`);
        if (existing) existing.remove();
        addTaskToUI(task);
        });

        socket.on("taskDeleted", ({ id }) => {
        const existing = document.querySelector(`[data-id="${id}"]`);
        if (existing) existing.remove();
        });

      const taskList = document.getElementById("taskList");
      const taskInput = document.getElementById("taskInput");
      const addTaskBtn = document.getElementById("addTask");
      const loginForm = document.getElementById("loginForm");
      const registerForm = document.getElementById("registerForm");
      const logoutBtn = document.getElementById("logoutBtn");
      const loadingIndicator = document.getElementById("loading");
      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");
      const registerUsername = document.getElementById("registerUsername");
      const registerPassword = document.getElementById("registerPassword");
      const toastContainer = document.getElementById("toastContainer");
      const loginTab = document.getElementById("loginTab");
      const registerTab = document.getElementById("registerTab");

      let token = localStorage.getItem("token");
      let editId = null;

      loginTab.onclick = () => {
        loginForm.classList.remove("d-none");
        registerForm.classList.add("d-none");
        loginTab.classList.add("active");
        registerTab.classList.remove("active");
      };
      registerTab.onclick = () => {
        loginForm.classList.add("d-none");
        registerForm.classList.remove("d-none");
        loginTab.classList.remove("active");
        registerTab.classList.add("active");
      };

      function showToast(message, type = "success") {
        const id = `toast-${Date.now()}`;
        const toastHtml = `
          <div id="${id}" class="toast align-items-center text-bg-${type} border-0 show" role="alert">
            <div class="d-flex">
              <div class="toast-body">${message}</div>
              <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        `;
        toastContainer.insertAdjacentHTML("beforeend", toastHtml);
        setTimeout(() => document.getElementById(id)?.remove(), 5000);
      }

      async function handleRequest(url, options, onSuccess, onError) {
        try {
          const res = await fetch(url, options);
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Something went wrong');
          onSuccess && onSuccess(data);
        } catch (err) {
          showToast(err.message, "danger");
          onError && onError(err);
        }
      }

      registerForm.onsubmit = (e) => {
        e.preventDefault();
        const body = JSON.stringify({ username: registerUsername.value, password: registerPassword.value });
        handleRequest("/api/auth/register", { method: "POST", headers: { 'Content-Type': 'application/json' }, body },
          () => {
            showToast("Registration successful! Please log in.", "success");
            loginTab.click();
          });
      };

      loginForm.onsubmit = (e) => {
        e.preventDefault();
        const body = JSON.stringify({ username: usernameInput.value, password: passwordInput.value });
        handleRequest("/api/auth/login", { method: "POST", headers: { 'Content-Type': 'application/json' }, body },
          (data) => {
            token = data.token;
            localStorage.setItem("token", token);
            showToast("Login successful!");
            updateUI();
          });
      };

      logoutBtn.onclick = () => {
        localStorage.removeItem("token");
        token = null;
        taskList.innerHTML = "";
        showToast("Logged out", "info");
        updateUI();
      };

      function updateUI() {
        if (token) {
          loginForm.classList.add("d-none");
          registerForm.classList.add("d-none");
          logoutBtn.classList.remove("d-none");
          loadTasks();
        } else {
          loginForm.classList.remove("d-none");
          logoutBtn.classList.add("d-none");
        }
      }

      function loadTasks() {
        loadingIndicator.classList.remove("d-none");
        handleRequest("/api/tasks", { headers: { Authorization: `Bearer ${token}` } },
          (tasks) => {
            taskList.innerHTML = "";
            tasks.forEach(addTaskToUI);
            loadingIndicator.classList.add("d-none");
          });
      }

      addTaskBtn.onclick = () => {
        const title = taskInput.value.trim();
        if (!title) return;
        addTaskBtn.disabled = true;
        handleRequest("/api/tasks", {
          method: "POST",
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify({ title })
        }, (task) => {
          addTaskToUI(task);
          taskInput.value = "";
        }, null).finally(() => addTaskBtn.disabled = false);
      };

        function addTaskToUI(task) {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.dataset.id = task.id;
        li.innerHTML = `
            <div class="form-check">
            <input class="form-check-input task-checkbox" type="checkbox" ${task.completed ? "checked" : ""}>
            <label class="form-check-label ${task.completed ? "text-decoration-line-through" : ""}">
                ${task.title}
            </label>
            </div>
            <div>
            <button class="btn btn-sm btn-outline-primary edit-btn">Edit</button>
            <button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
            </div>
        `;

        // Toggle task completion
        // li.querySelector(".task-checkbox").onchange = (e) => {
        //     const completed = e.target.checked;
        //     handleRequest(`/api/tasks/${task.id}`, {
        //     method: "PATCH",
        //     headers: {
        //         'Content-Type': 'application/json',
        //         Authorization: `Bearer ${token}`
        //     },
        //     body: JSON.stringify({ completed })
        //     }, (updatedTask) => {
        //     const label = li.querySelector(".form-check-label");
        //     if (completed) {
        //         label.classList.add("text-decoration-line-through");
        //     } else {
        //         label.classList.remove("text-decoration-line-through");
        //     }
        //     showToast("Task updated", "info");
        //     });
        // };
        // Toggle task completion
        li.querySelector(".task-checkbox").onchange = (e) => {
        const completed = e.target.checked;
        handleRequest(`/api/tasks/${task.id}`, {
            method: "PATCH",
            headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({ completed })
        }, (updatedTask) => {
            const label = li.querySelector(".form-check-label");
            label.classList.toggle("text-decoration-line-through", updatedTask.completed);
            showToast(`Task marked as ${updatedTask.completed ? "completed" : "incomplete"}`, "info");
        });
        };

        // Edit handler
        li.querySelector(".edit-btn").onclick = () => {
            editId = task.id;
            document.getElementById("editTaskTitle").value = task.title;
            new bootstrap.Modal(document.getElementById("editModal")).show();
        };

        // Delete handler
        li.querySelector(".delete-btn").onclick = () => {
            handleRequest(`/api/tasks/${task.id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` }
            }, () => {
            li.remove();
            showToast("Task deleted", "danger");
            });
        };

        taskList.prepend(li);
        }

      document.getElementById("saveEdit").onclick = () => {
        const newTitle = document.getElementById("editTaskTitle").value.trim();
        if (!newTitle) return;
        handleRequest(`/api/tasks/${editId}`, {
          method: "PATCH",
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify({ title: newTitle })
        }, () => {
          showToast("Task updated", "warning");
          loadTasks();
        });
        bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
      };

      updateUI();
    });
  </script>
</body>
</html>
